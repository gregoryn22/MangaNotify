<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8" />
<title>MangaNotify · WebUI</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="color-scheme" content="dark light" />
<meta name="description" content="Track manga updates, watchlist, and notifications." />

<!-- Favicons -->
<link rel="icon" href="/images/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">

<style>
  :root{
    --bg: #0b1020;
    --bg-soft: rgba(255,255,255,.06);
    --card: rgba(255,255,255,.08);
    --border: rgba(255,255,255,.12);
    --text: #e7e9f3;
    --muted: #9aa3b2;
    --accent: #7c9cff;
    --accent-strong: #4e75ff;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius: 14px;
    --focus: 2px solid color-mix(in oklab, var(--accent) 65%, #fff);
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f7f8fb; --bg-soft:#ffffffcf; --card:#ffffffd6; --border:#e6e8ee;
      --text:#111827; --muted:#5b6472; --accent:#375dfb; --accent-strong:#2147f0;
      --shadow: 0 10px 28px rgba(17,23,39,.08);
    }
  }
  [data-theme="light"]{
    --bg:#f7f8fb; --bg-soft:#ffffffcf; --card:#ffffffd6; --border:#e6e8ee;
    --text:#111827; --muted:#5b6472; --accent:#375dfb; --accent-strong:#2147f0;
    --shadow: 0 10px 28px rgba(17,23,39,.08);
  }
  [data-theme="dark"]{
    --bg: #0b1020; --bg-soft: rgba(255,255,255,.06); --card: rgba(255,255,255,.08);
    --border: rgba(255,255,255,.12); --text:#e7e9f3; --muted:#9aa3b2; --accent:#7c9cff; --accent-strong:#4e75ff;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text); background: var(--bg);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    letter-spacing:.2px;
  }

  @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; } }

  /* background glow */
  body::before{
    content:"";
    position:fixed; inset:0; z-index:-1; pointer-events:none;
    background:
      radial-gradient(120vmax 80vmax at 10% -10%, color-mix(in oklab, var(--accent) 25%, transparent) 0%, transparent 60%),
      radial-gradient(100vmax 70vmax at 90% 0%, color-mix(in oklab, #06b6d4 22%, transparent) 0%, transparent 55%),
      var(--bg);
    background-attachment: fixed,fixed,fixed;
    filter: saturate(110%);
  }

  .wrap{max-width:1200px; margin:0 auto; padding:28px 20px 60px}

  .header{
    position: sticky; top:0; z-index:30;
    backdrop-filter: saturate(120%) blur(10px);
    background: linear-gradient(to bottom, var(--bg-soft), transparent);
  }
  .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 20px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{ width:36px; height:36px; border-radius:12px; background: transparent; box-shadow: var(--shadow); display:grid; place-items:center; overflow: hidden; }
  .logo img{width: 100%; height: 100%; object-fit: contain; display: block;}
  .brand h1{margin:0;font-size:18px;letter-spacing:.4px}
  .actions{display:flex;gap:8px;align-items:center}

  .pill{
    border:1px solid var(--border); background:var(--card); color:var(--text);
    padding:10px 12px; border-radius:999px; display:flex; gap:10px; align-items:center;
    box-shadow: var(--shadow);
  }
  .input{
    background:transparent;border:none;outline:none;color:inherit;min-width:220px;font-size:14px;
  }
  .input:focus-visible, .btn:focus-visible, select:focus-visible, .input-mini:focus-visible {
    outline: var(--focus); outline-offset: 2px; border-radius: 10px;
  }
  .btn{
    border:1px solid var(--border); background:var(--card); color:var(--text);
    padding:10px 14px;border-radius:12px;cursor:pointer;transition:transform .12s ease, filter .12s ease;
    box-shadow: var(--shadow);
  }
  .btn:hover{transform:translateY(-1px)}
  .btn:active{transform:translateY(0); filter:saturate(110%)}
  .btn[disabled]{opacity:.6; cursor:not-allowed}
  .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-strong)); color:#fff; border-color:transparent}
  .btn.ghost{background:transparent}
  .muted{color:var(--muted)}
  .panel{margin-top:18px;background:color-mix(in oklab, var(--card) 88%, transparent);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;padding:16px}
  .card{ border:1px solid var(--border); border-radius:16px; overflow:hidden; background:var(--bg-soft); box-shadow: var(--shadow); transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease; display:flex; flex-direction:column; }
  .card:hover{transform:translateY(-2px); border-color: color-mix(in oklab, var(--accent) 50%, var(--border)); box-shadow:0 18px 40px rgba(0,0,0,.18)}
  .cover{position:relative; aspect-ratio:2/3; background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02))}
  .cover img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; object-position:center; display:block; border-bottom:1px solid var(--border)}
  .shimmer{background:linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.15), rgba(255,255,255,.06)); background-size:200% 100%; animation:sh 1.1s infinite}
  @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .meta{padding:10px 12px 12px; display:flex; flex-direction:column; gap:8px}
  .title{font-weight:700; font-size:14px; line-height:1.25; margin:0}
  .subline{font-size:12px; color:var(--muted)}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}

  .watch{padding:10px 12px}
  .watch-item{ display:flex; gap:12px; align-items:center; justify-content:space-between; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:var(--bg-soft) }
  .watch-list{display:grid; gap:10px; padding:0 12px 14px}
  .pager{display:flex; gap:10px; justify-content:center; padding:12px}
  .chip{border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted)}
  .toast{position:fixed; right:18px; bottom:18px; background:#111827; color:#fff; padding:12px 14px; border-radius:12px; box-shadow:0 18px 40px rgba(0,0,0,.35); opacity:0; transform:translateY(8px); pointer-events:none; transition:opacity .15s, transform .15s; font-size:14px; z-index:50}
  .toast.show{opacity:1; transform:translateY(0); pointer-events:auto}
  footer{opacity:.8; font-size:12px; text-align:center; margin-top:22px; color:var(--muted)}
  a{color:var(--accent)}
  @media (max-width:520px){ .hide-sm{display:none} }

  .badge{ display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:var(--bg-soft); color:var(--muted) }
  .badge.ok{ color:#16a34a; border-color:#16a34a33 }
  .badge.warn{ color:#ef4444; border-color:#ef444433 }

  .input-mini{ width:84px; padding:8px 10px; font-size:13px; background:transparent; border:1px solid var(--border); border-radius:10px; color:var(--text) }
  .controls .btn{ padding:8px 10px }
  .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }

  .unread-dot{ width:8px; height:8px; border-radius:999px; background: #ef4444; box-shadow: 0 0 0 0 rgba(239,68,68,.55); animation: pulse 1.8s ease-out infinite; flex: 0 0 auto; margin-top:4px }
  @keyframes pulse{ 0%{box-shadow: 0 0 0 0 rgba(239,68,68,.55)} 70%{box-shadow: 0 0 0 12px rgba(239,68,68,0)} 100%{box-shadow: 0 0 0 0 rgba(239,68,68,0)} }
  .watch-item.unread{ border-color: color-mix(in oklab, #ef4444 45%, var(--border)); box-shadow: 0 8px 24px rgba(239,68,68,.08) }

  .toolbar{ display:flex; gap:10px; align-items:center; justify-content:space-between; padding: 0 12px 10px }
  .left-tools, .right-tools{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .checkbox{display:flex; align-items:center; gap:6px; font-size:13px; color:var(--muted)}

  /* modal */
  dialog { border:1px solid var(--border); border-radius:12px; background:var(--card); color:var(--text); padding:0; max-width:720px }
  dialog::backdrop { background: rgba(0,0,0,.4) }
  .modal-head{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border) }
  .modal-body{ padding:12px 14px; display:grid; gap:10px }
  .kvs{ font-size:13px; color:var(--muted) }
  .kvs code{ font-size:12px }
  .tags{ display:flex; flex-wrap:wrap; gap:6px }
</style>
</head>
<body>
  <header class="header" role="banner">
    <div class="head-inner wrap" style="padding-inline:20px;">
      <div class="brand" aria-label="App brand">
        <div class="logo" aria-hidden="true">
          <img src="/images/manganotify_logo.png" alt="" decoding="async">
        </div>
        <h1 aria-label="MangaNotify">MangaNotify</h1>
      </div>
      <div class="actions" role="search">
        <div class="pill" style="gap:8px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M21 21l-3.6-3.6M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
          <input id="q" class="input" placeholder="Search series…" autocomplete="off" aria-label="Search series" />
          <button id="go" class="btn primary" aria-label="Run search">Search</button>
        </div>
        <button id="theme" class="btn hide-sm" title="Toggle theme (t)">Theme</button>
      </div>
    </div>
  </header>

  <main class="wrap" id="main" tabindex="-1">
    <div class="row" style="margin-top:10px; align-items:baseline">
      <div class="chip" id="status" aria-live="polite">Ready</div>
      <div class="chip hide-sm" id="result-info"></div>
      <div class="chip" id="net" title="Network status">Online</div>
      <div class="chip" id="last-refresh" title="Auto-refresh clock" aria-live="polite" hidden>—</div>
    </div>

    <!-- Search filters -->
    <section class="panel" style="margin-top:12px; padding:10px 12px">
      <div class="row" style="gap:8px; align-items:center; flex-wrap:wrap">
        <label class="subline" for="f-status">Status</label>
        <select id="f-status" class="btn" style="padding:8px 10px">
          <option value="">Any</option>
          <option>releasing</option>
          <option>finished</option>
          <option>hiatus</option>
          <option>cancelled</option>
          <option>upcoming</option>
        </select>

        <label class="subline" for="f-type">Type</label>
        <select id="f-type" class="btn" style="padding:8px 10px">
          <option value="">Any</option>
          <option value="manga">manga</option>
          <option value="manhwa">manhwa</option>
          <option value="manhua">manhua</option>
          <option value="novel">novel</option>
          <option value="one_shot">one_shot</option>
        </select>

        <label class="checkbox">
          <input id="f-has-anime" type="checkbox"> Has anime
        </label>

        <label class="subline" for="f-cr">Content</label>
        <select id="f-cr" class="btn" style="padding:8px 10px">
          <option value="">Any</option>
          <option value="safe">safe</option>
          <option value="suggestive">suggestive</option>
          <option value="erotica">erotica</option>
          <option value="pornographic">pornographic</option>
        </select>

        <button id="f-clear" class="btn">Clear filters</button>
      </div>
    </section>

    <!-- Results -->
    <section class="panel" id="results-panel" aria-label="Search results" hidden>
      <div id="results" class="grid" role="list"></div>
      <div class="pager" id="pager" hidden>
        <button class="btn" id="prev" aria-label="Previous page">‹ Prev</button>
        <div class="chip" id="page-indicator" aria-live="polite"></div>
        <button class="btn" id="next" aria-label="Next page">Next ›</button>
      </div>
    </section>

    <!-- Notifications -->
    <section class="panel" style="margin-top:16px; overflow:hidden">
      <div class="row" style="justify-content:space-between; padding:12px 12px 0 12px">
        <h2 style="margin:0">Notifications</h2>
        <div class="row">
          <button id="notify-test" class="btn">Send test</button>
          <button id="debug-toggle" class="btn ghost" aria-expanded="false" aria-controls="notify-debug">Debug</button>
        </div>
      </div>
      <div id="notify-debug" style="display:none; padding:10px 12px 14px; color:var(--muted); font-size:13px"></div>
    </section>

    <!-- Watchlist -->
    <section class="panel" style="margin-top:16px;" aria-label="Watchlist">
      <div class="watch">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h2 style="margin:0">Watchlist</h2>
          <div class="row" style="gap:8px; align-items:center">
            <div class="chip" id="watch-count">0 items</div>
            <div class="chip hide-sm" id="watch-unread-count" title="Unread across visible items">Unread: 0</div>
          </div>
        </div>
      </div>

      <div class="toolbar">
        <div class="left-tools">
          <button id="refresh" class="btn" title="Refresh watchlist from cache (r)">↻ Refresh</button>
          <button id="refresh-now" class="btn" title="Reload watchlist from server">Reload (server)</button>

          <label class="subline" for="sort-by">Sort</label>
          <select id="sort-by" class="btn" style="padding:8px 10px" aria-label="Sort by">
            <option value="title">Title (A→Z)</option>
            <option value="unread">Unread chapters (high→low)</option>
            <option value="chapters">Total chapters (high→low)</option>
            <option value="last_checked">Last checked (new→old)</option>
            <option value="added_at">Added (new→old)</option>
          </select>
          <button id="sort-dir" class="btn" title="Toggle sort direction">⬆︎</button>

          <label class="subline" for="auto-refresh">Auto-refresh</label>
          <select id="auto-refresh" class="btn" style="padding:8px 10px" aria-label="Auto-refresh interval">
            <option value="0">Off</option>
            <option value="60">1 min</option>
            <option value="300">5 min</option>
            <option value="900">15 min</option>
          </select>
        </div>

        <div class="right-tools">
          <label class="checkbox" title="Only show series with unread chapters">
            <input id="unread-only" type="checkbox"> Show unread only
          </label>
          <label class="checkbox" title="Toggle cover images in list (saves bandwidth)">
            <input id="show-covers" type="checkbox" checked> Show covers
          </label>
          <button id="bulk-mark-latest" class="btn" title="Mark visible items as latest">Mark all latest (visible)</button>
          <button id="export" class="btn" title="Export watchlist to JSON">Export</button>
          <label class="btn" for="import-file" title="Import watchlist from JSON" style="cursor:pointer">Import</label>
          <input id="import-file" type="file" accept="application/json" style="display:none" />
        </div>
      </div>

      <div id="watchlist" class="watch-list"></div>
    </section>

    <footer>Built with ❤️ for reading. API: /api/search, /api/series/:id, /api/watchlist, /api/notify/test</footer>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Modal -->
  <dialog id="modal">
    <div class="modal-head">
      <div class="row">
        <strong id="modal-title">Details</strong>
      </div>
      <button id="modal-close" class="btn">Close</button>
    </div>
    <div class="modal-body">
      <div id="modal-body"></div>
    </div>
  </dialog>

<script>
/* ===== Helpers / State ===== */
const $  = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));
const state = {
  q:"", page:1, limit:20, pagination:null,
  sortBy: localStorage.getItem("mn-sort-by")  || "title",
  sortDir: localStorage.getItem("mn-sort-dir") || "asc",
  unreadOnly: localStorage.getItem("mn-unread-only") === "true",
  showCovers: localStorage.getItem("mn-show-covers") !== "false",
  autoRefresh: +(localStorage.getItem("mn-auto-refresh") || "0"),
  autoTimer: null,
  lastRefreshTs: null,
  online: navigator.onLine,
  filters: {
    status: localStorage.getItem("mn-f-status") || "",
    type: localStorage.getItem("mn-f-type") || "",
    has_anime: localStorage.getItem("mn-f-has-anime") === "true",
    content_rating: localStorage.getItem("mn-f-cr") || ""
  },
  aborter: null
};

function toast(msg, ms=2200){ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), ms); }
function setStatus(text){ $("#status").textContent = text || "—"; }
function parseProgress(v){ const n = parseFloat(String(v ?? "").replace(",", ".")); return Number.isFinite(n) ? Math.max(0, n) : 0; }
function unreadCount(total, lastRead){ const t=Number(total)||0; const r=parseProgress(lastRead); return Math.max(0, t - Math.floor(r)); }
const dtFormatter = new Intl.DateTimeFormat(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit", hour12:false, timeZoneName:"short" });
function formatLocal(iso){ try{ return dtFormatter.format(new Date(iso)); } catch { return iso || ""; } }
function timeAgo(iso){
  try{
    const then = new Date(iso).getTime(); if(!Number.isFinite(then)) return "";
    const s = Math.max(0, (Date.now() - then) / 1000);
    const units = [["yr", 365*24*3600], ["mo", 30*24*3600], ["d", 24*3600], ["h", 3600], ["m", 60], ["s", 1]];
    for(const [label, secs] of units){ const v=Math.floor(s/secs); if(v>=1) return `${v}${label} ago`; }
    return "just now";
  }catch{ return ""; }
}

/* ===== Theme toggle ===== */
(function initTheme(){
  const saved = localStorage.getItem("mn-theme");
  if(saved){ document.documentElement.setAttribute("data-theme", saved); }
  $("#theme").onclick = ()=>{
    const cur = document.documentElement.getAttribute("data-theme");
    const next = cur === "light" ? "dark" : "light";
    document.documentElement.setAttribute("data-theme", next);
    localStorage.setItem("mn-theme", next);
  };
})();

/* ===== Network status ===== */
function updateNet(){
  state.online = navigator.onLine;
  $("#net").textContent = state.online ? "Online" : "Offline";
  $("#net").style.color = state.online ? "#16a34a" : "#ef4444";
  ["go","refresh","refresh-now","notify-test","bulk-mark-latest","export"].forEach(id=>{
    const el = $("#"+id); if(el) el.disabled = !state.online && id!=="export";
  });
}
window.addEventListener("online",  updateNet);
window.addEventListener("offline", updateNet);

/* ===== Debounce & URL helpers ===== */
function debounce(fn, ms=350){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }
function buildQuery(params){ return Object.entries(params).filter(([,v])=>v!=="" && v!==undefined && v!==null).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join("&"); }
function syncUrl(){
  const p = new URLSearchParams();
  if(state.q) p.set("q", state.q);
  for(const [k,v] of Object.entries(state.filters)){
    if(v && !(k==="has_anime" && v===false)) p.set(k, v===true ? "1" : v);
  }
  history.replaceState(null, "", p.toString() ? `?${p}` : location.pathname);
}
function restoreFromUrl(){
  const p = new URLSearchParams(location.search);
  if(p.get("q")) $("#q").value = p.get("q");
  const remap = {status:"f-status", type:"f-type", content_rating:"f-cr", has_anime:"f-has-anime"};
  Object.entries(remap).forEach(([key,id])=>{
    const val = p.get(key);
    if(val !== null){
      if(id==="f-has-anime") { $("#"+id).checked = val==="1" || val==="true"; }
      else { $("#"+id).value = val; }
    }
  });
}

/* ===== Modal ===== */
const modal = $("#modal");
$("#modal-close").onclick = ()=> modal.close();

/* ===== Search & render ===== */
const debouncedSearch = debounce(()=> runSearch(), 300);

function searchParams(){
  const params = {
    q: state.q,
    page: state.page,
    limit: state.limit
  };
  if(state.filters.status) params.status = state.filters.status;
  if(state.filters.type) params.type = state.filters.type;
  if(state.filters.content_rating) params.content_rating = state.filters.content_rating;
  if(state.filters.has_anime) params.has_anime = "true";
  return params;
}

async function search(){
  // Abort previous search if any
  if(state.aborter){ state.aborter.abort(); }
  state.aborter = new AbortController();

  setStatus("Searching…");
  $("#results-panel").hidden=false;
  $("#results").innerHTML = Array.from({length:8}).map(()=>`
    <div class="card" role="listitem" aria-busy="true">
      <div class="cover shimmer"></div>
      <div class="meta">
        <div class="title shimmer" style="height:16px;border-radius:6px"></div>
        <div class="subline shimmer" style="height:12px;border-radius:6px;width:70%"></div>
      </div>
    </div>`).join("");

  try{
    const qs = buildQuery(searchParams());
    const res = await fetch(`/api/search?${qs}`, { signal: state.aborter.signal });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const js = await res.json();
    renderResults(js);
    setStatus("Done");
  }catch(e){
    if(e.name === "AbortError") return;
    $("#results").innerHTML = `<div style="padding:18px" class="subline">Search failed. ${e}</div>`;
    setStatus("Search failed");
  }
}

function renderResults(js){
  const items = js.data || js.results || [];
  const p = js.pagination || null;
  state.pagination = p;

  const info = p ? `Page ${p.page} · ${p.count} result${p.count===1?"":"s"}` : `${items.length} result${items.length===1?"":"s"}`;
  $("#result-info").textContent = info;

  const box=$("#results");
  box.innerHTML="";
  if(!items.length){
    box.innerHTML = `<div style="padding:18px" class="subline">No results.</div>`;
    $("#pager").hidden=true;
    return;
  }

  for(const it of items){
    const el=document.createElement("div");
    el.className="card"; el.setAttribute("role","listitem");
    const title = it.title || it.romanized_title || it.native_title || "(no title)";
    // cover can be url string or object (back-compat)
    let cover = "";
    if (typeof it.cover === "string") cover = it.cover;
    else if (it.cover && (it.cover.small || it.cover.default || it.cover.raw)) cover = it.cover.small || it.cover.default || it.cover.raw;

    const total = it.total_chapters ?? "—";
    const cr = (it.content_rating || "").toLowerCase();
    const status = it.status || "";

    el.innerHTML = `
      <div class="cover ${cover ? "" : "shimmer"}">${cover ? `<img src="${cover}" alt="${title} cover" loading="lazy" decoding="async">` : ""}</div>
      <div class="meta">
        <h3 class="title" title="${title}">${title}</h3>
        <div class="subline">ID: <code>${it.id}</code> · Chapters: ${total}${status?` · ${status}`:""}${cr?` · ${cr}`:""}</div>
        <div class="row">
          <button class="btn" data-add="${it.id}">Watch</button>
          <button class="btn" data-open="${it.id}">Open</button>
          <button class="btn" data-details="${it.id}">Details</button>
          <button class="btn" data-copy="${it.id}" title="Copy ID">Copy ID</button>
        </div>
      </div>`;
    box.appendChild(el);

    const img = el.querySelector("img");
    if(img){
      img.addEventListener("load", ()=> el.querySelector(".cover").classList.remove("shimmer"));
      img.addEventListener("error", ()=> el.querySelector(".cover").classList.add("shimmer"));
    }

    el.querySelector(`[data-add="${it.id}"]`).onclick = async ()=>{
      const r = await fetch("/api/watchlist", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ id: it.id, title, total_chapters: total || null, last_read: 0, cover })
      });
      if(r.ok){ toast("Added to watchlist"); loadWatchlist(); }
      else { toast("Failed to add", 2600); }
    };
    el.querySelector(`[data-open="${it.id}"]`).onclick = ()=> window.open(`https://mangabaka.dev/${it.id}`, "_blank");
    el.querySelector(`[data-copy="${it.id}"]`).onclick = async ()=>{ try{ await navigator.clipboard.writeText(String(it.id)); toast("ID copied"); }catch{ toast("Copy failed", 2200); } };
    el.querySelector(`[data-details="${it.id}"]`).onclick = ()=> openDetails(it.id, title);
  }

  if(p){
    $("#pager").hidden=false;
    $("#page-indicator").textContent = `Page ${p.page}`;
    $("#prev").disabled = !p.previous;
    $("#next").disabled = !p.next;
  }else{
    $("#pager").hidden=true;
  }
}

/* ===== Details modal (relationships + links from /api/series/{id}) ===== */
async function openDetails(id, title){
  $("#modal-title").textContent = title || `Series ${id}`;
  const body = $("#modal-body");
  body.innerHTML = `<div class="subline">Loading…</div>`;
  modal.showModal();
  try{
    const res = await fetch(`/api/series/${id}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const js = await res.json();
    const series = js.data || {};
    const rel = (series.relationships) || {};
    const links = Array.isArray(series.links) ? series.links : [];

    const relHtml = Object.keys(rel).length
      ? Object.entries(rel).map(([kind, arr])=>{
          const items = (arr||[]).map(sid=>`<a href="https://mangabaka.dev/${sid}" target="_blank" rel="noopener">${sid}</a>`).join(" · ");
          return `<div class="kvs"><strong>${kind}</strong>: ${items || "<span class='muted'>(none)</span>"}</div>`;
        }).join("")
      : `<div class="muted">No relationships provided.</div>`;

    const linksHtml = links.length
      ? `<div class="tags">${links.map(u=>`<a class="badge" href="${u}" target="_blank" rel="noopener">${new URL(u).hostname}</a>`).join("")}</div>`
      : `<div class="muted">No external links.</div>`;

    body.innerHTML = `
      <div>${relHtml}</div>
      <div><strong>Links</strong>${linksHtml}</div>
    `;
  }catch(e){
    body.innerHTML = `<div class="subline">Failed to load details. ${e}</div>`;
  }
}

/* ===== Watchlist ===== */
async function loadWatchlist(){
  const res = await fetch("/api/watchlist");
  const js = await res.json();
  let list = js.data || [];

  if(state.unreadOnly){
    list = list.filter(it => {
      const total = Number.isFinite(+it.total_chapters) ? +it.total_chapters : null;
      const lastRead = parseProgress(it.last_read ?? 0);
      const unread = total!==null ? unreadCount(total, lastRead) : 0;
      return unread > 0;
    });
  }

  list = sortWatchlist(list);

  $("#watch-count").textContent = `${list.length} item${list.length===1?"":"s"}`;
  const totalUnreadVisible = list.reduce((sum, it)=>{
    const tot = Number.isFinite(+it.total_chapters) ? +it.total_chapters : null;
    const last = parseProgress(it.last_read ?? 0);
    return sum + (tot!==null ? unreadCount(tot, last) : 0);
  }, 0);
  $("#watch-unread-count").textContent = `Unread: ${totalUnreadVisible}`;

  const box = $("#watchlist");
  box.innerHTML = "";

  if(!list.length){
    box.innerHTML = `<div class="subline" style="padding:0 12px 16px">Nothing here yet. Add items from the search results.</div>`;
    return;
  }

  for(const it of list){
    const total = Number.isFinite(+it.total_chapters) ? +it.total_chapters : null;
    const lastRead = parseProgress(it.last_read ?? 0);
    const unread = total!==null ? unreadCount(total, lastRead) : 0;
    const behind = total!==null ? unread > 0 : false;

    const lastCheckedTxt = it.last_checked ? `· Last checked: ${timeAgo(it.last_checked)}` : "";
    const lastChapterTxt = it.last_chapter_at ? `· Last update: ${timeAgo(it.last_chapter_at)}` : "";
    const mergeTxt = it.merge_note ? ` · <span class="badge">merged</span>` : "";

    const row = document.createElement("div");
    row.className = "watch-item" + (behind ? " unread" : "");
    row.innerHTML = `
      <div style="min-width:0; display:flex; gap:10px; align-items:flex-start">
        ${behind ? `<span class="unread-dot" title="Unread chapters"></span>` : ``}
        ${state.showCovers && it.cover ? `<img src="${it.cover}" alt="" width="40" height="60" loading="lazy" decoding="async" style="border-radius:6px; border:1px solid var(--border); object-fit:cover" />` : ""}
        <div style="min-width:0">
          <div style="font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap" title="${it.title || ""}">
            ${it.title || "(no title)"} ${mergeTxt}
          </div>
          <div class="subline" title="${it.last_checked ? formatLocal(it.last_checked) : ""}">
            ID: <code>${it.id}</code>
            · Chapters: ${total ?? "—"}
            ${lastCheckedTxt} ${lastChapterTxt}
            ${it.status? ` · ${it.status}` : ""} ${it.content_rating? ` · ${it.content_rating}` : ""}
          </div>
          <div class="row" style="margin-top:6px; gap:8px">
            <span class="badge ${behind ? "warn":"ok"}" title="Unread chapters">
              ${behind ? "Unread" : "Up to date"}${total!==null ? `: ${unread}` : ""}
            </span>
            ${(total!==null) ? `<span class="badge">Read: ${String(lastRead).replace(/\.0$/,"")}/${total}</span>` : ""}
            ${(it.authors && it.authors.length) ? `<span class="badge" title="Authors">${it.authors[0]}${it.authors.length>1?"…":""}</span>` : ""}
          </div>
        </div>
      </div>

      <div class="controls">
        ${total!==null ? `
          <button class="btn" data-prev="${it.id}" title="Decrement read (−1)">−1</button>
          <input class="input-mini" type="number" min="0" ${total!==null ? `max="${total}"`:""}
                 step="1" value="${String(lastRead).replace(/\.0$/,"")}" aria-label="Last read chapter" data-lr="${it.id}" />
          <button class="btn" data-set="${it.id}" title="Set last read">Set</button>
          <button class="btn" data-next="${it.id}" title="Increment read (+1)">+1</button>
          <button class="btn" data-latest="${it.id}" title="Mark latest">Mark latest</button>
        ` : ""}
        <button class="btn" data-details="${it.id}" title="Details">Details</button>
        <button class="btn" data-open="${it.id}" title="Open series page">Open</button>
        <button class="btn" data-copy="${it.id}" title="Copy ID">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M9 9V5a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-4m-4 6H7a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </button>
        <button class="btn" data-remove="${it.id}" title="Remove">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 7h16M9 3h6m-8 4 1 13a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2l1-13" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    `;

    const id = it.id;
    row.querySelector(`[data-open="${id}"]`).onclick = ()=> window.open(`https://mangabaka.dev/${id}`, "_blank");
    row.querySelector(`[data-copy="${id}"]`).onclick = async ()=>{ try{ await navigator.clipboard.writeText(String(id)); toast("ID copied"); }catch{ toast("Copy failed", 2200); } };
    row.querySelector(`[data-details="${id}"]`).onclick = ()=> openDetails(id, it.title || `Series ${id}`);

    row.querySelector(`[data-remove="${id}"]`).onclick = async ()=>{
      const r = await fetch(`/api/watchlist/${id}`, { method:"DELETE" });
      if(r.ok){ toast("Removed"); loadWatchlist(); } else { toast("Failed to remove", 2600); }
    };

    const inp = row.querySelector(`[data-lr="${id}"]`);
    const btnSet = row.querySelector(`[data-set="${id}"]`);
    if(btnSet && inp){
      btnSet.onclick = async ()=>{
        const val = parseProgress(inp.value);
        const r = await fetch(`/api/watchlist/${id}/progress`, {
          method:"PATCH",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ last_read: val })
        });
        if(r.ok){ toast("Progress updated"); loadWatchlist(); }
        else { toast("Failed to update", 2600); }
      };
    }

    const btnNext = row.querySelector(`[data-next="${id}"]`);
    if(btnNext){
      btnNext.onclick = async ()=>{
        const r = await fetch(`/api/watchlist/${id}/read/next`, { method:"POST" });
        if(r.ok){ toast("+1 read"); loadWatchlist(); } else { toast("Failed to bump", 2600); }
      };
    }
    const btnPrev = row.querySelector(`[data-prev="${id}"]`);
    if(btnPrev){
      btnPrev.onclick = async ()=>{
        const r = await fetch(`/api/watchlist/${id}/progress`, {
          method:"PATCH",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ decrement: 1 })
        });
        if(r.ok){ toast("−1 read"); loadWatchlist(); } else { toast("Failed to decrement", 2600); }
      };
    }

    const btnLatest = row.querySelector(`[data-latest="${id}"]`);
    if(btnLatest){
      btnLatest.onclick = async ()=>{
        const r = await fetch(`/api/watchlist/${id}/progress`, {
          method:"PATCH",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ mark_latest: true })
        });
        if(r.ok){ toast("Marked latest"); loadWatchlist(); } else { toast("Failed to mark", 2600); }
      };
    }

    $("#watchlist").appendChild(row);
  }

  state.lastRefreshTs = Date.now();
}

/* ===== Sorting ===== */
function sortWatchlist(list){
  const by = state.sortBy;
  const dir = state.sortDir === "desc" ? -1 : 1;

  return [...list].sort((a, b) => {
    const aTitle = (a.title || "").toLowerCase();
    const bTitle = (b.title || "").toLowerCase();

    const aTotal = Number.isFinite(+a.total_chapters) ? +a.total_chapters : null;
    const bTotal = Number.isFinite(+b.total_chapters) ? +b.total_chapters : null;

    const aLast = parseProgress(a.last_read ?? 0);
    const bLast = parseProgress(b.last_read ?? 0);

    const aUnread = aTotal !== null ? unreadCount(aTotal, aLast) : -1;
    const bUnread = bTotal !== null ? unreadCount(bTotal, bLast) : -1;

    const aChecked = a.last_checked ? Date.parse(a.last_checked) : 0;
    const bChecked = b.last_checked ? Date.parse(b.last_checked) : 0;

    const aAdded = a.added_at ? Date.parse(a.added_at) : 0;
    const bAdded = b.added_at ? Date.parse(b.added_at) : 0;

    let cmp = 0;
    switch(by){
      case "title":        cmp = aTitle.localeCompare(bTitle); break;
      case "unread":       cmp = (bUnread - aUnread); break;
      case "chapters":     cmp = ((bTotal ?? -1) - (aTotal ?? -1)); break;
      case "last_checked": cmp = (bChecked - aChecked); break;
      case "added_at":     cmp = (bAdded - aAdded); break;
      default:             cmp = 0;
    }
    return dir === 1 ? cmp : -cmp;
  });
}

/* ===== Export / Import ===== */
async function exportWatchlist(){
  try{
    const res = await fetch("/api/watchlist");
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const js = await res.json();
    const blob = new Blob([JSON.stringify(js, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `manganotify_watchlist_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    toast("Exported watchlist");
  }catch(e){ toast(`Export failed: ${e}`, 4000); }
}

async function importWatchlist(file){
  try{
    const text = await file.text();
    const js = JSON.parse(text);
    const items = (js.data || js.results || js || []).filter(Boolean);
    if(!Array.isArray(items) || !items.length){ toast("Nothing to import", 2600); return; }

    let ok=0, fail=0;
    for(const it of items){
      try{
        const body = { id: it.id, title: it.title, total_chapters: it.total_chapters ?? null, last_read: it.last_read ?? 0, cover: it.cover };
        const r = await fetch("/api/watchlist", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
        if(r.ok) ok++; else fail++;
      }catch{ fail++; }
    }
    toast(`Import finished · OK ${ok} · Failed ${fail}`, 4200);
    loadWatchlist();
  }catch(e){ toast(`Import failed: ${e}`, 4200); }
}

/* ===== Bulk mark latest (visible) ===== */
async function bulkMarkLatest(){
  const rows = $$("#watchlist .watch-item");
  if(!rows.length){ toast("No items to mark"); return; }
  let ok=0, fail=0;
  for(const row of rows){
    const id = (row.querySelector(".subline code")||{}).textContent;
    if(!id) continue;
    try{
      const r = await fetch(`/api/watchlist/${id}/progress`, {
        method:"PATCH",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ mark_latest: true })
      });
      if(r.ok) ok++; else fail++;
    }catch{ fail++; }
  }
  toast(`Marked latest · OK ${ok} · Failed ${fail}`, 3800);
  loadWatchlist();
}

/* ===== Auto-refresh clock ===== */
function startAutoRefresh(){
  clearInterval(state.autoTimer);
  if(!state.autoRefresh){ $("#last-refresh").hidden = true; return; }
  $("#last-refresh").hidden = false;
  const tick = ()=>{
    if(state.lastRefreshTs){
      $("#last-refresh").textContent = `Refreshed ${timeAgo(state.lastRefreshTs)} (every ${state.autoRefresh/60|0 || 1}m)`;
    }else{
      $("#last-refresh").textContent = `Next refresh in ${state.autoRefresh/60|0 || 1}m`;
    }
  };
  state.autoTimer = setInterval(async ()=>{
    await loadWatchlist();
    tick();
  }, state.autoRefresh * 1000);
  tick();
}

/* ===== Wiring ===== */
function runSearch(){
  state.q = $("#q").value.trim();
  syncUrl();
  if(state.q) search();
}

$("#go").onclick = runSearch;
$("#q").addEventListener("keydown", e=>{ if(e.key==="Enter") runSearch(); });
$("#q").addEventListener("input", debouncedSearch);

$("#prev").onclick = ()=>{ if(state.pagination?.previous){ state.page = Math.max(1, (state.page-1)||1); search(); } };
$("#next").onclick = ()=>{ if(state.pagination?.next){ state.page = state.page+1; search(); } };

$("#notify-test").onclick = async ()=>{
  const btn=$("#notify-test"); btn.disabled=true;
  try{
    const res = await fetch("/api/notify/test", { method:"POST" });
    const text = await res.text(); let js={}; try{ js=JSON.parse(text);}catch{}
    if(res.ok && js.ok){ toast("✅ Test notification sent!"); }
    else{
      const detail=(js.errors&&js.errors.join("; "))||js.message||text||`HTTP ${res.status}`;
      toast(`❌ Notification failed: ${detail}`, 5000);
      console.warn("notify/test response:", {status:res.status, body:text});
    }
  }catch(e){ toast("❌ Network error calling /api/notify/test", 4200); }
  finally{ btn.disabled=false; }
};
$("#debug-toggle").onclick = ()=>{
  const el=$("#notify-debug");
  const showing = el.style.display !== "none";
  el.style.display = showing ? "none" : "block";
  $("#debug-toggle").setAttribute("aria-expanded", String(!showing));
  if(!showing) refreshNotifyDebug();
};
$("#refresh").onclick = ()=> loadWatchlist();
$("#refresh-now").onclick = async ()=>{
  try{
    // No explicit server "refresh" route; poller runs in background.
    // Just force a reload from server storage.
    await loadWatchlist();
    toast("Reloaded watchlist from server");
  }catch{ toast("Reload failed", 2600); }
};

$("#sort-by")?.addEventListener("change", e => {
  state.sortBy = e.target.value;
  state.sortDir = (state.sortBy === "title") ? "asc" : "desc";
  localStorage.setItem("mn-sort-by", state.sortBy);
  localStorage.setItem("mn-sort-dir", state.sortDir);
  $("#sort-dir").textContent = state.sortDir === "asc" ? "⬆︎" : "⬇︎";
  loadWatchlist();
});
$("#sort-dir")?.addEventListener("click", () => {
  state.sortDir = state.sortDir === "asc" ? "desc" : "asc";
  localStorage.setItem("mn-sort-dir", state.sortDir);
  $("#sort-dir").textContent = state.sortDir === "asc" ? "⬆︎" : "⬇︎";
  loadWatchlist();
});

$("#unread-only")?.addEventListener("change", e => {
  state.unreadOnly = !!e.target.checked;
  localStorage.setItem("mn-unread-only", String(state.unreadOnly));
  loadWatchlist();
});

$("#show-covers")?.addEventListener("change", e=>{
  state.showCovers = !!e.target.checked;
  localStorage.setItem("mn-show-covers", String(state.showCovers));
  loadWatchlist();
});

$("#auto-refresh")?.addEventListener("change", e=>{
  state.autoRefresh = +e.target.value;
  localStorage.setItem("mn-auto-refresh", String(state.autoRefresh));
  startAutoRefresh();
});

/* Filters wiring */
$("#f-status").addEventListener("change", e=>{ state.filters.status = e.target.value; localStorage.setItem("mn-f-status", state.filters.status); syncUrl(); if(state.q) search(); });
$("#f-type").addEventListener("change", e=>{ state.filters.type = e.target.value; localStorage.setItem("mn-f-type", state.filters.type); syncUrl(); if(state.q) search(); });
$("#f-has-anime").addEventListener("change", e=>{ state.filters.has_anime = !!e.target.checked; localStorage.setItem("mn-f-has-anime", String(state.filters.has_anime)); syncUrl(); if(state.q) search(); });
$("#f-cr").addEventListener("change", e=>{ state.filters.content_rating = e.target.value; localStorage.setItem("mn-f-cr", state.filters.content_rating); syncUrl(); if(state.q) search(); });
$("#f-clear").onclick = ()=>{
  state.filters = {status:"", type:"", has_anime:false, content_rating:""};
  $("#f-status").value=""; $("#f-type").value=""; $("#f-has-anime").checked=false; $("#f-cr").value="";
  localStorage.removeItem("mn-f-status"); localStorage.removeItem("mn-f-type"); localStorage.removeItem("mn-f-has-anime"); localStorage.removeItem("mn-f-cr");
  syncUrl(); if(state.q) search();
};

$("#bulk-mark-latest").onclick = bulkMarkLatest;
$("#export").onclick = exportWatchlist;
$("#import-file").addEventListener("change", e=>{
  const f = e.target.files?.[0]; if(f) importWatchlist(f);
  e.target.value = "";
});

/* Keyboard shortcuts — safe around inputs */
function isEditable(el) {
  return !!el && (el.tagName === "INPUT" || el.tagName === "TEXTAREA" || el.isContentEditable);
}
document.addEventListener("keydown", (e) => {
  if (isEditable(e.target) || e.metaKey || e.ctrlKey || e.altKey) return;
  if (e.key === "/") { e.preventDefault(); $("#q")?.focus(); return; }
  if (e.key.toLowerCase() === "t") { e.preventDefault(); $("#theme")?.click(); return; }
  if (e.key.toLowerCase() === "r") { e.preventDefault(); $("#refresh")?.click(); return; }
});

/* apply saved UI on load */
window.addEventListener("DOMContentLoaded", () => {
  restoreFromUrl();
  updateNet();
  const sb = $("#sort-by");
  const sd = $("#sort-dir");
  const ur = $("#unread-only");
  const sc = $("#show-covers");
  const ar = $("#auto-refresh");
  const fs = $("#f-status"), ft = $("#f-type"), fha = $("#f-has-anime"), fcr = $("#f-cr");
  if (sb) sb.value = state.sortBy;
  if (sd) sd.textContent = state.sortDir === "asc" ? "⬆︎" : "⬇︎";
  if (ur) ur.checked = !!state.unreadOnly;
  if (sc) sc.checked = !!state.showCovers;
  if (ar) ar.value = String(state.autoRefresh || 0);
  if (fs) fs.value = state.filters.status || "";
  if (ft) ft.value = state.filters.type || "";
  if (fha) fha.checked = !!state.filters.has_anime;
  if (fcr) fcr.value = state.filters.content_rating || "";
});

/* ===== Init ===== */
setStatus("Ready");
loadWatchlist();
startAutoRefresh();

async function refreshNotifyDebug(){
  const el=$("#notify-debug");
  try{
    const res=await fetch("/api/notify/debug");
    if(!res.ok){ el.textContent="(debug endpoint not reachable)"; return; }
    const js=await res.json();
    el.innerHTML = `
      <div>has_token: <b>${js.has_token}</b> (${js.token_preview||""})</div>
      <div>has_user: <b>${js.has_user}</b> (${js.user_preview||""})</div>
      <div class="subline" style="margin-top:6px">${js.notes||""}</div>`;
  }catch{ el.textContent="(debug fetch failed)"; }
}
</script>
</body>
</html>
